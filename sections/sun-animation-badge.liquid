<style>
.sun-animation-section {
  padding: 40px 20px;
  background: #fff;
  text-align: center;
}

.sun-animation-container {
  max-width: 1200px;
  margin: 0 auto;
}

.sun-animation-wrapper {
  display: inline-block;
  margin: 0 auto;
}

#sun_animation_container {
  background-color: rgba(255, 255, 255, 1.00);
  width: 400px;
  height: 400px;
  margin: 0 auto;
  position: relative;
}

#sun_canvas {
  width: 400px;
  height: 400px;
  position: absolute;
  display: block;
  background-color: rgba(255, 255, 255, 1.00);
}

#sun_dom_overlay_container {
  pointer-events: none;
  overflow: hidden;
  width: 400px;
  height: 400px;
  position: absolute;
  left: 0px;
  top: 0px;
  display: block;
}

/* Responsive */
@media (max-width: 768px) {
  .sun-animation-section {
    padding: 30px 20px;
  }
  
  #sun_animation_container,
  #sun_canvas,
  #sun_dom_overlay_container {
    width: 280px;
    height: 280px;
  }
}
</style>

<section class="sun-animation-section">
  <div class="sun-animation-container">
    <div class="sun-animation-wrapper">
      <div id="sun_animation_container">
        <canvas id="sun_canvas" width="400" height="400"></canvas>
        <div id="sun_dom_overlay_container"></div>
      </div>
    </div>
  </div>
</section>

<script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
<script src="{{ 'olitalia-sun-animation.js' | asset_url }}"></script>
<script>
var canvas, stage, exportRoot, anim_container, dom_overlay_container, fnStartAnimation;

// Override manifest with proper Shopify asset URLs
window.sunAnimationManifest = [
  {src: "{{ 'Layer1GradientMap1.png' | asset_url }}", id: "Layer1GradientMap1"},
  {src: "{{ 'olitalia sun animation_atlas_1.png' | asset_url }}", id: "olitalia_sun_animation_atlas_1"}
];

function initSunAnimation() {
  canvas = document.getElementById("sun_canvas");
  anim_container = document.getElementById("sun_animation_container");
  dom_overlay_container = document.getElementById("sun_dom_overlay_container");
  
  var comp = AdobeAn.getComposition("117E02CA86B748899282774A40150680");
  var lib = comp.getLibrary();
  
  // Override the manifest with Shopify URLs
  lib.properties.manifest = window.sunAnimationManifest;
  
  var loader = new createjs.LoadQueue(false);
  
  loader.addEventListener("fileload", function(evt){
    handleFileLoad(evt,comp);
  });
  
  loader.addEventListener("complete", function(evt){
    handleComplete(evt,comp);
  });
  
  loader.loadManifest(lib.properties.manifest);
}

function handleFileLoad(evt, comp) {
  var images = comp.getImages();    
  if (evt && (evt.item.type == "image")) { 
    images[evt.item.id] = evt.result; 
  }    
}

function handleComplete(evt,comp) {
  var lib = comp.getLibrary();
  var ss = comp.getSpriteSheet();
  var queue = evt.target;
  var ssMetadata = lib.ssMetadata;
  
  for(i=0; i<ssMetadata.length; i++) {
    ss[ssMetadata[i].name] = new createjs.SpriteSheet({
      "images": [queue.getResult(ssMetadata[i].name)], 
      "frames": ssMetadata[i].frames
    });
  }
  
  exportRoot = new lib.olitaliasunanimation();
  stage = new lib.Stage(canvas);
  
  // Original animation bounds: 135.6 x 142.5px
  // Scale to fit 400px canvas: 400 / 136 = ~2.94x
  var scale = 2.94;
  exportRoot.scaleX = exportRoot.scaleY = scale;
  
  // Center the scaled animation
  // Scaled size: 136 * 2.94 = ~400px
  exportRoot.x = 0;
  exportRoot.y = 0;
  
  fnStartAnimation = function() {
    stage.addChild(exportRoot);
    createjs.Ticker.framerate = lib.properties.fps;
    createjs.Ticker.addEventListener("tick", stage);
    
    // Stop animation immediately and go to first frame
    exportRoot.gotoAndStop(0);
  }
  
  AdobeAn.makeResponsive(false,'both',false,1,[canvas,anim_container,dom_overlay_container]);
  AdobeAn.compositionLoaded(lib.properties.id);
  fnStartAnimation();
  
  // Setup Intersection Observer to play animation when scrolled into view
  var isPlaying = false;
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting && !isPlaying) {
        isPlaying = true;
        exportRoot.gotoAndPlay(0);
        
        // Variables for easing effect
        var totalFrames = exportRoot.totalFrames;
        var normalFPS = lib.properties.fps;
        var slowdownStart = totalFrames * 0.7; // Start slowing down at 70%
        
        var checkFrame = function() {
          var currentFrame = exportRoot.currentFrame;
          
          // Apply slowdown effect in last 30% of animation
          if (currentFrame >= slowdownStart) {
            var progress = (currentFrame - slowdownStart) / (totalFrames - slowdownStart);
            var slowdownFactor = 1 - (progress * 0.6); // Slow down to 40% speed
            createjs.Ticker.framerate = normalFPS * slowdownFactor;
          }
          
          // Stop at end
          if (currentFrame >= totalFrames - 1) {
            exportRoot.gotoAndStop(totalFrames - 1);
            createjs.Ticker.framerate = normalFPS; // Reset to normal speed
            createjs.Ticker.removeEventListener("tick", checkFrame);
            isPlaying = false; // Allow animation to play again
          }
        };
        
        createjs.Ticker.addEventListener("tick", checkFrame);
      }
    });
  }, {
    threshold: 0.5 // Trigger when 50% of element is visible
  });
  
  observer.observe(anim_container);
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSunAnimation);
} else {
  initSunAnimation();
}
</script>

{% schema %}
{
  "name": "Sun Animation Badge",
  "settings": [
    {
      "type": "header",
      "content": "Animation Settings"
    },
    {
      "type": "paragraph",
      "content": "Animated sun badge with olive branch and text"
    }
  ],
  "presets": [
    {
      "name": "Sun Animation Badge"
    }
  ]
}
{% endschema %}
