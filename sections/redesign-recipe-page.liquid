{{ 'redesign-recipe-page.css' | asset_url | stylesheet_tag }}
<script src="{{ 'recipe-cooking-mode.js' | asset_url }}" defer></script>
<script src="{{ 'redesign-recipe-print.js' | asset_url }}" defer></script>
<script src="{{ 'redesign-recipe-ingredients.js' | asset_url }}" defer></script>
<script src="{{ 'recipe-interactions.js' | asset_url }}" defer></script>
<script src="{{ 'recipe-product-links.js' | asset_url }}" defer></script>

<section class="redesign-recipe redesign-recipe-page">
  <div class="redesign-recipe__container">
    <div class="redesign-recipe__header">
      <div class="redesign-recipe__header-content">
        <h1 class="redesign-recipe__title">{{ page.title }}</h1>
        
        {% if page.metafields.recipe.category or page.metafields.recipe.difficulty %}
          <div class="redesign-recipe__tags">
            {% if page.metafields.recipe.category %}
              {% assign category_key = page.metafields.recipe.category | downcase %}
              {% assign category_display = 'recipes.category.' | append: category_key | t | default: page.metafields.recipe.category %}
              <span class="redesign-recipe__tag">{{ category_display }}</span>
            {% endif %}
            {% if page.metafields.recipe.difficulty %}
              {% assign difficulty_key = page.metafields.recipe.difficulty | downcase %}
              {% assign difficulty_display = 'recipes.difficulty.' | append: difficulty_key | t | default: page.metafields.recipe.difficulty %}
              <span class="redesign-recipe__tag">{{ difficulty_display }}</span>
            {% endif %}
          </div>
        {% endif %}
        
        {% if page.metafields.recipe.description %}
          <div class="redesign-recipe__description">
            {{ page.metafields.recipe.description }}
          </div>
        {% elsif page.content != blank %}
          <div class="redesign-recipe__description">
            {{ page.content }}
          </div>
        {% endif %}

        <div class="redesign-recipe__meta">
          {% if page.metafields.recipe.prep_time %}
            <div class="redesign-recipe__meta-item">
              <span class="redesign-recipe__meta-label">Prep Time</span>
              <span class="redesign-recipe__meta-value">{{ page.metafields.recipe.prep_time }}</span>
            </div>
          {% endif %}
          
          {% if page.metafields.recipe.cook_time %}
            <div class="redesign-recipe__meta-item">
              <span class="redesign-recipe__meta-label">Cook Time</span>
              <span class="redesign-recipe__meta-value">{{ page.metafields.recipe.cook_time }}</span>
            </div>
          {% endif %}
          
          {% if page.metafields.recipe.total_time %}
            <div class="redesign-recipe__meta-item">
              <span class="redesign-recipe__meta-label">Total Time</span>
              <span class="redesign-recipe__meta-value">{{ page.metafields.recipe.total_time }}</span>
            </div>
          {% endif %}
          
          {% if page.metafields.recipe.servings %}
            <div class="redesign-recipe__meta-item">
              <span class="redesign-recipe__meta-label">Servings</span>
              <span class="redesign-recipe__meta-value">{{ page.metafields.recipe.servings }}</span>
            </div>
          {% endif %}
        </div>

        {% comment %} Action Buttons {% endcomment %}
        <div class="redesign-recipe-actions">
          <button class="redesign-recipe-cooking-btn" id="cookingModeToggle">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 13.87A4 4 0 0 1 7.41 6a5.11 5.11 0 0 1 1.05-1.54 5 5 0 0 1 7.08 0A5.11 5.11 0 0 1 16.59 6 4 4 0 0 1 18 13.87V21H6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="6" y1="21" x2="18" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="cooking-mode-text">Start Baking / Cooking</span>
          </button>
          
          <button class="redesign-recipe-print-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 9V2H18V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M6 18H4C3.44772 18 3 17.5523 3 17V11C3 10.4477 3.44772 10 4 10H20C20.5523 10 21 10.4477 21 11V17C21 17.5523 20.5523 18 20 18H18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M6 14H18V22H6V14Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Print Recipe
          </button>
        </div>
        
        <p class="redesign-recipe-wakelock-info">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Cooking/Baking mode prevents your screen from turning off while you cook or bake.
        </p>
      </div>

      <div class="redesign-recipe__hero">
        {% if page.metafields.recipe.featured_image %}
          <img 
            src="{{ page.metafields.recipe.featured_image | image_url: width: 800 }}" 
            alt="{{ page.title }}"
            class="redesign-recipe__hero-image"
          >
        {% endif %}
      </div>
    </div>

    <div class="redesign-recipe__body">
      <aside class="redesign-recipe__sidebar">
      <div class="redesign-recipe__sidebar-sticky">
        {% comment %} Load featured product once for use in both ingredients and product card {% endcomment %}
        {% assign product_handle = page.metafields.recipe.featured_product | default: section.settings.featured_product %}
        {% assign featured_product = all_products[product_handle] %}
        
        {% if page.metafields.recipe.ingredients %}
          <div class="redesign-recipe__sidebar-section">
            <h3>Ingredients</h3>
            <div class="redesign-recipe__sidebar-list">
              <ul>
                
                {% if page.metafields.recipe.ingredients.value %}
                  {% for ingredient in page.metafields.recipe.ingredients.value %}
                    {% assign is_featured = false %}
                    {% if ingredient.featured == true or ingredient.featured == "true" %}
                      {% assign is_featured = true %}
                    {% endif %}
                    {% comment %} Fallback: Check if ingredient name contains "Olitalia" {% endcomment %}
                    {% if ingredient.name contains "Olitalia" %}
                      {% assign is_featured = true %}
                    {% endif %}
                    <li {% if is_featured %}class="featured-ingredient"{% endif %}>
                      <label class="redesign-recipe__checkbox-label">
                        <input type="checkbox" class="redesign-recipe__checkbox">
                        <span class="redesign-recipe__checkbox-custom"></span>
                        <span class="redesign-recipe__ingredient-text">{{ ingredient.amount }} {{ ingredient.name }}</span>
                        {% if is_featured and featured_product and featured_product.featured_image %}
                          <img src="{{ featured_product.featured_image | image_url: width: 60 }}" alt="{{ featured_product.title }}" class="ingredient-product-icon">
                        {% endif %}
                      </label>
                    </li>
                  {% endfor %}
                {% else %}
                  {% assign ingredients_json = page.metafields.recipe.ingredients %}
                  {% for ingredient in ingredients_json %}
                    {% assign is_featured = false %}
                    {% if ingredient.featured == true or ingredient.featured == "true" %}
                      {% assign is_featured = true %}
                    {% endif %}
                    {% comment %} Fallback: Check if ingredient name contains "Olitalia" {% endcomment %}
                    {% if ingredient.name contains "Olitalia" %}
                      {% assign is_featured = true %}
                    {% endif %}
                    <li {% if is_featured %}class="featured-ingredient"{% endif %}>
                      <label class="redesign-recipe__checkbox-label">
                        <input type="checkbox" class="redesign-recipe__checkbox">
                        <span class="redesign-recipe__checkbox-custom"></span>
                        <span class="redesign-recipe__ingredient-text">{{ ingredient.amount }} {{ ingredient.name }}</span>
                        {% if is_featured and featured_product and featured_product.featured_image %}
                          <img src="{{ featured_product.featured_image | image_url: width: 60 }}" alt="{{ featured_product.title }}" class="ingredient-product-icon">
                        {% endif %}
                      </label>
                    </li>
                  {% endfor %}
                {% endif %}
              </ul>
            </div>
            
            <button class="redesign-recipe-shop-btn" id="shopRecipeBtn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="9" cy="21" r="1"/>
                <circle cx="20" cy="21" r="1"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
              </svg>
              Shop This Recipe
            </button>
          </div>
        {% endif %}
      </div>
      </aside>

      <div class="redesign-recipe__content">
        {% if page.metafields.recipe.instructions %}
          <div class="redesign-recipe__section">
            <h2 class="redesign-recipe__section-title">Instructions</h2>
            <div class="redesign-recipe__instructions">
              <ul class="redesign-recipe__instructions-list">
                {% if page.metafields.recipe.instructions.value %}
                  {% for step in page.metafields.recipe.instructions.value %}
                    <li class="redesign-recipe__instruction-item">
                      <label class="redesign-recipe__checkbox-label">
                        <input type="checkbox" class="redesign-recipe__checkbox">
                        <span class="redesign-recipe__checkbox-custom"></span>
                        <span class="redesign-recipe__instruction-text">{{ step.step }}</span>
                      </label>
                    </li>
                  {% endfor %}
                {% else %}
                  {% assign instructions_json = page.metafields.recipe.instructions %}
                  {% for step in instructions_json %}
                    <li class="redesign-recipe__instruction-item">
                      <label class="redesign-recipe__checkbox-label">
                        <input type="checkbox" class="redesign-recipe__checkbox">
                        <span class="redesign-recipe__checkbox-custom"></span>
                        <span class="redesign-recipe__instruction-text">{{ step.step }}</span>
                      </label>
                    </li>
                  {% endfor %}
                {% endif %}
              </ul>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Shop Recipe Modal -->
<div class="recipe-shop-modal" id="recipeShopModal">
  <div class="recipe-shop-modal__overlay"></div>
  <div class="recipe-shop-modal__content">
    <button class="recipe-shop-modal__close" id="closeShopModal">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    
    <h2 class="recipe-shop-modal__title">Shop This Recipe</h2>
    <p class="recipe-shop-modal__subtitle">Get the ingredients you need</p>
    
    <div class="recipe-shop-modal__products">
      {% if featured_product %}
        <div class="recipe-shop-modal__product">
          <div class="recipe-shop-modal__product-image">
            {% if featured_product.featured_image %}
              <img src="{{ featured_product.featured_image | image_url: width: 400 }}" alt="{{ featured_product.title }}">
            {% endif %}
          </div>
          <div class="recipe-shop-modal__product-info">
            <h3>{{ featured_product.title }}</h3>
            <p class="recipe-shop-modal__product-price">{{ featured_product.price | money }}</p>
            <a href="{{ featured_product.url }}" class="recipe-shop-modal__product-btn">View Product</a>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script src="{{ 'recipe-shop-modal.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "Redesign Recipe Page",
  "settings": [
    {
      "type": "richtext",
      "id": "ingredients",
      "label": "Ingredients",
      "info": "List of ingredients"
    },
    {
      "type": "richtext",
      "id": "instructions",
      "label": "Instructions",
      "info": "Step by step instructions"
    },
    {
      "type": "product",
      "id": "featured_product",
      "label": "Featured Product"
    }
  ]
}
{% endschema %}
